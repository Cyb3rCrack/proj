version: '3.8'

services:
  # Main Zypherus API service
  zypherus:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: "3.10"
    
    container_name: zypherus-api
    
    ports:
      - "${API_PORT:-8000}:8000"
    
    environment:
      # Core
      ENVIRONMENT: ${ENVIRONMENT:-production}
      DEBUG: "false"
      API_HOST: 0.0.0.0
      API_PORT: 8000
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      
      # Security (CHANGE THESE IN PRODUCTION!)
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-me-in-production}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      JWT_EXPIRY_HOURS: ${JWT_EXPIRY_HOURS:-24}
      REQUIRE_AUTH: ${REQUIRE_AUTH:-true}
      
      # API Configuration
      WORKERS: ${WORKERS:-4}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-30}
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      
      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS:-100}
      RATE_LIMIT_PERIOD: ${RATE_LIMIT_PERIOD:-60}
      
      # Models
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      EMBEDDING_CACHE_SIZE: ${EMBEDDING_CACHE_SIZE:-1000}
      DEVICE: ${DEVICE:-cpu}
      
      # Memory
      MAX_MEMORY_MB: ${MAX_MEMORY_MB:-2048}
      ENABLE_PERSISTENCE: ${ENABLE_PERSISTENCE:-true}
      
      # Monitoring
      SENTRY_ENABLED: ${SENTRY_ENABLED:-true}
      SENTRY_DSN: ${SENTRY_DSN:-}
      SENTRY_ENVIRONMENT: ${SENTRY_ENVIRONMENT:-production}
    
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
    
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT:-2}'
          memory: ${MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${CPU_RESERVE:-1}'
          memory: ${MEMORY_RESERVE:-2G}
    
    # Logs  
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    networks:
      - zypherus-network

  # Optional: Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: zypherus-nginx
    
    ports:
      - "80:80"
      - "${HTTPS_PORT:-443}:443"
    
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    
    depends_on:
      - zypherus
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    networks:
      - zypherus-network
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  zypherus-network:
    driver: bridge

volumes:
  data:
    driver: local
  logs:
    driver: local
  config:
    driver: local

